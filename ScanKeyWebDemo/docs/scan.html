<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ScanKey ‚Äî Escanear</title>
  <link rel="stylesheet" href="styles.css"/>
  <style>
    .preview { width:100%; max-width:420px; aspect-ratio:4/3; object-fit:cover; border-radius:14px; border:1px solid #2b2c34; }
    .box { display:flex; flex-direction:column; gap:12px; align-items:center; }
    .hint { color:#a1a1aa; font-size:.9rem; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:.9rem; white-space:pre-wrap; }
  </style>
</head>
<body>
  <header class="topbar">
    <div class="brand">ScanKey</div>
    <nav>
      <a href="index.html">Inicio</a>
      <a href="scan.html" class="active">Escanear</a>
      <a href="results.html">Resultados</a>
    </nav>
  </header>

  <main class="container">
    <section class="card">
      <h1>Escanear llave (demo web)</h1>
      <p class="hint">Consejo: coloca la llave sobre fondo claro, usa buena luz y enfoca el contorno.</p>

      <div class="box">
        <input id="file" type="file" accept="image/*" capture="environment" />
        <img id="preview" class="preview" alt="Vista previa" />

        <div class="actions">
          <button class="btn" id="btnAnalyze">Analizar llave</button>
          <a class="btn ghost" href="results.html">Ver √∫ltimos resultados</a>
        </div>

        <details class="card" style="max-width:800px; width:100%;">
          <summary><b>√öltima respuesta del backend</b></summary>
          <pre id="out" class="mono">‚Äî</pre>
        </details>
      </div>
    </section>
  </main>

  <footer class="foot">¬© ScanKey Demo</footer>

  <script>
    // === Config API (ajustada a tu servicio en Cloud Run) ===
    const API_URL = "https://scankey-mini-578907855193.europe-southwest1.run.app/analyze";
    const API_KEY = "12345";

    const $file = document.getElementById("file");
    const $preview = document.getElementById("preview");
    const $btn = document.getElementById("btnAnalyze");
    const $out = document.getElementById("out");

    // Vista previa de la imagen
    $file.addEventListener("change", () => {
      const f = $file.files?.[0];
      if (!f) { $preview.src = ""; return; }
      const url = URL.createObjectURL(f);
      $preview.src = url;
    });

    // Analizar (subir a la API)
    $btn.addEventListener("click", async () => {
      const f = $file.files?.[0];
      if (!f) { alert("Selecciona una foto primero."); return; }

      const form = new FormData();
      form.append("image", f, f.name || "photo.jpg");
      form.append("device_id", "gh-pages-demo");
      form.append("side", "A");
      form.append("force_ocr", "false");

      $btn.disabled = true;
      $btn.textContent = "Analizando‚Ä¶";

      try {
        const res = await fetch(API_URL, {
          method: "POST",
          headers: { "X-API-Key": API_KEY },
          body: form
        });

        if (!res.ok) {
          const txt = await res.text();
          throw new Error(`HTTP ${res.status}: ${txt}`);
        }

        const data = await res.json();
        // üî• Guardar para la pantalla de resultados
        localStorage.setItem("sk_last_result", JSON.stringify(data));
        $out.textContent = JSON.stringify(data, null, 2);
      } catch (e) {
        $out.textContent = "Error: " + (e?.message || e);
      } finally {
        $btn.disabled = false;
        $btn.textContent = "Analizar llave";
      }
    });
  </script>
</body>
</html>
// ====== C√°mara HTML5 (beta) ======
let camStream = null;
let currentBlob = null;  // si hay foto capturada, la usamos en lugar del input
const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const btnOpenCam = document.getElementById('btnOpenCam');
const btnShot = document.getElementById('btnShot');
const btnCloseCam = document.getElementById('btnCloseCam');
const previewImg = document.getElementById('previewImg'); // ya existe en tu p√°gina
const fileInput = document.getElementById('fileInput');

async function startCamera() {
  try {
      camStream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: { ideal: "environment" } },
                  audio: false
                      });
                          video.srcObject = camStream;
                              video.style.display = 'block';
                                  btnShot.disabled = false;
                                      btnCloseCam.disabled = true; // se habilita cuando el v√≠deo tenga tama√±o
                                          currentBlob = null; // resetea captura previa
                                              previewImg.removeAttribute('src');
                                                  previewImg.style.display = 'none';

                                                      // Espera a que el v√≠deo tenga dimensiones reales
                                                          video.onloadedmetadata = () => {
                                                                btnCloseCam.disabled = false;
                                                                    };
                                                                      } catch (e) {
                                                                          alert("No se pudo abrir la c√°mara: " + (e?.message || e));
                                                                            }
                                                                            }

                                                                            function stopCamera() {
                                                                              if (camStream) {
                                                                                  camStream.getTracks().forEach(t => t.stop());
                                                                                      camStream = null;
                                                                                        }
                                                                                          video.srcObject = null;
                                                                                            video.style.display = 'none';
                                                                                              btnShot.disabled = true;
                                                                                                btnCloseCam.disabled = true;
                                                                                                }

                                                                                                btnOpenCam?.addEventListener('click', startCamera);
                                                                                                btnCloseCam?.addEventListener('click', stopCamera);

                                                                                                btnShot?.addEventListener('click', () => {
                                                                                                  if (!video || !video.videoWidth) return;
                                                                                                    const w = video.videoWidth;
                                                                                                      const h = video.videoHeight;
                                                                                                        canvas.width = w;
                                                                                                          canvas.height = h;
                                                                                                            const ctx = canvas.getContext('2d');
                                                                                                              ctx.drawImage(video, 0, 0, w, h);
                                                                                                                canvas.toBlob(blob => {
                                                                                                                    if (!blob) return;
                                                                                                                        currentBlob = blob;
                                                                                                                            const url = URL.createObjectURL(blob);
                                                                                                                                previewImg.src = url;
                                                                                                                                    previewImg.style.display = 'block';
                                                                                                                                      }, 'image/jpeg', 0.92);
                                                                                                                                      });
                                                                                                                                      
                                                                                                                                      // ====== Hookear an√°lisis para usar la foto de c√°mara si existe ======
                                                                                                                                      async function getImageForAnalyze() {
                                                                                                                                        // 1) prioriza la foto capturada desde la c√°mara
                                                                                                                                          if (currentBlob instanceof Blob) return currentBlob;
                                                                                                                                          
                                                                                                                                            // 2) si no, usa el input file
                                                                                                                                              if (fileInput?.files?.length) return fileInput.files[0];
                                                                                                                                              
                                                                                                                                                throw new Error("No hay imagen seleccionada ni capturada.");
                                                                                                                                                }
                                                                                                                                                
                                                                                                                                                // Si tienes ya una funci√≥n analyze() o similar, modifica la parte donde se crea el FormData:
                                                                                                                                                window._sk_prepareFormData = async function(form) {
                                                                                                                                                  // esta funci√≥n la llamaremos justo antes de enviar
                                                                                                                                                    const img = await getImageForAnalyze();
                                                                                                                                                      form.append("image", img, "photo.jpg");
                                                                                                                                                      };
                                                                                                                                                      
                                                                                                                                                      // En tu c√≥digo de env√≠o, justo antes de fetch(...):
                                                                                                                                                      // const form = new FormData();
                                                                                                                                                      // await window._sk_prepareFormData(form);
                                                                                                                                                      // ... resto igual ...
