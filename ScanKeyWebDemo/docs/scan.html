<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ScanKey â€” Escanear</title>
  <link rel="stylesheet" href="styles.css"/>
  <style>
    .preview { width:100%; max-width:420px; aspect-ratio:4/3; object-fit:cover; border-radius:14px; border:1px solid #2b2c34; }
    .box { display:flex; flex-direction:column; gap:12px; align-items:center; }
    .hint { color:#a1a1aa; font-size:.9rem; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:.9rem; white-space:pre-wrap; }
  </style>
</head>
<body>
  <header class="topbar">
    <div class="brand">ScanKey</div>
    <nav>
      <a href="index.html">Inicio</a>
      <a href="scan.html" class="active">Escanear</a>
      <a href="results.html">Resultados</a>
    </nav>
  </header>

  <main class="container">
    <section class="card">
      <h1>Escanear llave (demo web)</h1>
      <p class="hint">Consejo: coloca la llave sobre fondo claro, usa buena luz y enfoca el contorno.</p>

      <div class="box">
        <input id="file" type="file" accept="image/*" capture="environment" />
        <img id="preview" class="preview" alt="Vista previa" />

        <div class="actions">
          <button class="btn" id="btnAnalyze">Analizar llave</button>
          <a class="btn ghost" href="results.html">Ver Ãºltimos resultados</a>
        </div>

        <details class="card" style="max-width:800px; width:100%;">
          <summary><b>Ãšltima respuesta del backend</b></summary>
          <pre id="out" class="mono">â€”</pre>
        </details>
      </div>
    </section>
  </main>

  <footer class="foot">Â© ScanKey Demo</footer>

  <script>
    // === Config API (ajustada a tu servicio en Cloud Run) ===
    const API_URL = "https://scankey-mini-578907855193.europe-southwest1.run.app/analyze";
    const API_KEY = "12345";

    const $file = document.getElementById("file");
    const $preview = document.getElementById("preview");
    const $btn = document.getElementById("btnAnalyze");
    const $out = document.getElementById("out");

    // Vista previa de la imagen
    $file.addEventListener("change", () => {
      const f = $file.files?.[0];
      if (!f) { $preview.src = ""; return; }
      const url = URL.createObjectURL(f);
      $preview.src = url;
    });

    // Analizar (subir a la API)
    $btn.addEventListener("click", async () => {
      const f = $file.files?.[0];
      if (!f) { alert("Selecciona una foto primero."); return; }

      const form = new FormData();
      form.append("image", f, f.name || "photo.jpg");
      form.append("device_id", "gh-pages-demo");
      form.append("side", "A");
      form.append("force_ocr", "false");

      $btn.disabled = true;
      $btn.textContent = "Analizandoâ€¦";

      try {
        const res = await fetch(API_URL, {
          method: "POST",
          headers: { "X-API-Key": API_KEY },
          body: form
        });

        if (!res.ok) {
          const txt = await res.text();
          throw new Error(`HTTP ${res.status}: ${txt}`);
        }

        const data = await res.json();
        // ðŸ”¥ Guardar para la pantalla de resultados
        localStorage.setItem("sk_last_result", JSON.stringify(data));
        $out.textContent = JSON.stringify(data, null, 2);
      } catch (e) {
        $out.textContent = "Error: " + (e?.message || e);
      } finally {
        $btn.disabled = false;
        $btn.textContent = "Analizar llave";
      }
    });
  </script>
</body>
</html>
